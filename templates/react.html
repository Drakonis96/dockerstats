<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Docker Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    body[data-bs-theme="dark"] {
      background-color: #1a1a1a;
      color: #e0e0e0;
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState, useEffect} = React;

function App() {
  const [containers, setContainers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [selected, setSelected] = useState(null);
  const [chartData, setChartData] = useState(null);
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');

  useEffect(() => {
    document.body.setAttribute('data-bs-theme', theme);
    localStorage.setItem('theme', theme);
  }, [theme]);

  useEffect(() => {
    const fetchMetrics = () => {
      fetch('/api/metrics')
        .then(res => res.json())
        .then(data => { setContainers(data); setLoading(false); })
        .catch(err => { console.error(err); setLoading(false); });
    };
    fetchMetrics();
    const id = setInterval(fetchMetrics, 5000);
    return () => clearInterval(id);
  }, []);

  const filtered = containers.filter(c => c.name.toLowerCase().includes(search.toLowerCase()));

  const showHistory = container => {
    fetch(`/api/history/${container.id}?range=3600`)
      .then(res => res.json())
      .then(data => { setSelected(container); setChartData(data); })
      .catch(console.error);
  };

  useEffect(() => {
    if (!chartData) return;
    const ctx = document.getElementById('historyChart');
    if (!ctx) return;
    if (window.historyChart) window.historyChart.destroy();
    const labels = chartData.timestamps.map(ts => new Date(ts*1000).toLocaleTimeString());
    window.historyChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'CPU %', data: chartData.cpu_usage, borderColor: 'red', fill: false },
          { label: 'RAM %', data: chartData.ram_usage, borderColor: 'blue', fill: false }
        ]
      },
      options: { scales: { y: { beginAtZero: true } } }
    });
  }, [chartData]);

  if (loading) return <div className="text-center mt-5">Loading...</div>;

  return (
    <div className="container mt-4">
      <div className="d-flex justify-content-between mb-3">
        <input type="text" className="form-control w-50" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} />
        <button className="btn btn-outline-secondary ms-2" onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}>{theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}</button>
      </div>
      <table className="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>CPU %</th>
            <th>RAM %</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {filtered.map(c => (
            <tr key={c.id} onClick={() => showHistory(c)} style={{cursor:'pointer'}}>
              <td>{c.name}</td>
              <td>{c.cpu !== null ? c.cpu.toFixed(2) : 'N/A'}</td>
              <td>{c.mem !== null ? c.mem.toFixed(2) : 'N/A'}</td>
              <td>{c.status}</td>
              <td><a className="btn btn-sm btn-secondary" href={`/logs/${c.id}`} onClick={e => e.stopPropagation()}>Logs</a></td>
            </tr>
          ))}
        </tbody>
      </table>
      {selected && (
        <div className="mt-4">
          <h5 className="text-center">History: {selected.name}</h5>
          <canvas id="historyChart" height="200"></canvas>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
